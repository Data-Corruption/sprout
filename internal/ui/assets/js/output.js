(()=>{var S="nord",g="forest",p="SPROUT_THEME";function k(){return localStorage.getItem(p)||(window.matchMedia?.("(prefers-color-scheme: dark)").matches?g:S)}function b(){return k()===g}function E(){let e=document.getElementById("theme-toggle");e&&(e.checked=b())}function M(e){localStorage.setItem(p,e),document.documentElement.setAttribute("data-theme",e),E()}function v(){M(b()?S:g)}function C(){let e=k();document.documentElement.setAttribute("data-theme",e),localStorage.setItem(p,e)}function I(){E()}function u(){let e=document.getElementById("click-blocker");e&&e.classList.remove("hidden")}function a(){let e=document.getElementById("click-blocker");e&&e.classList.add("hidden")}function h(e){e&&(e.className="status loading loading-spinner loading-xs",e.textContent="",e.dataset.errorMessage="",e.onclick=null)}function w(e){e&&(e.className="status status-success",e.dataset.errorMessage="",e.onclick=null,setTimeout(()=>{e.classList.contains("status-success")&&(e.className="status hidden")},2e3))}function T(e){let n=e.closest("label");if(n){let t=n.querySelector(".status");if(t)return t}let r=e.closest(".flex");if(r){let t=r.querySelector(".status");if(t)return t}let s=e.closest(".form-control");return s?s.querySelector(".status"):null}function c(e){let n=document.getElementById("error-modal"),r=document.getElementById("error-modal-message");n&&r&&(r.textContent=e,n.showModal())}function P(){u(),fetch("/settings/stop",{method:"POST"}).then(e=>{if(e.ok)document.title="Server Stopped",document.body.className="bg-base-100 min-h-screen flex items-center justify-center",document.body.innerHTML=`
                    <div class="text-center">
                        <h1 class="text-2xl font-bold mb-2">Server Stopped</h1>
                        <p class="text-base-content/70">You can close this tab.</p>
                    </div>
                `;else throw new Error("Failed to stop server")}).catch(e=>{a(),c("Error: "+e.message)})}function N(){let e=document.getElementById("restart-update").checked;document.getElementById("restart-modal").close(),u(),fetch("/settings/restart",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({update:e})}).then(n=>{if(n.ok||n.status===202)setTimeout(()=>H(e),3e3);else throw new Error("Failed to restart server")}).catch(n=>{a(),c("Error: "+n.message)})}function H(e=!1){let n=Date.now(),r=3e3,s=3e5,t=()=>{if(Date.now()-n>s){a(),c("Restart timed out. Please check logs or try again.");return}console.log("Polling for restart...",{updateRequested:e,time:Date.now()-n}),fetch("/settings/restart-status?t="+Date.now()).then(o=>o.json()).then(o=>{console.log("Poll response:",o),o.restarted?e&&!o.updated?(console.warn("Restart detected but not updated.",o),a(),c("Restart completed, but the update did not apply. You may already be on the latest version, or the update failed.")):(console.log("Restart success (updated="+o.updated+"), reloading..."),window.location.reload()):setTimeout(t,r)}).catch(o=>{console.error("Poll network error (expected if restarting):",o),setTimeout(t,r)})};t()}async function x(e,n,r){let s=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n),signal:r});if(!s.ok){let t=await s.text();throw new Error(t||`HTTP ${s.status}`)}return s}function L(e,n,r,s){let t=typeof e=="string"?document.getElementById(e):e;if(!t)return;let o=T(t);t.addEventListener("change",async()=>{h(o);try{await x(n,{[r]:t.value}),w(o),s&&s()}catch(l){c(o,l.message)}})}function m(e,n,r,s=500,t={}){let o=typeof e=="string"?document.getElementById(e):e;if(!o)return;let l=T(o),y=null,d=null;o.addEventListener("input",()=>{clearTimeout(y),d&&d.abort(),y=setTimeout(async()=>{if(!(t.skipEmpty&&!o.value.trim())){d=new AbortController,h(l);try{let i=o.value;if(o.type==="number"&&(i=parseInt(i,10),isNaN(i)))throw new Error("Invalid number");await x(n,{[r]:i},d.signal),w(l),t.onSuccess&&t.onSuccess()}catch(i){i.name!=="AbortError"&&c(l,i.message)}}},s)})}function f(){let e=document.getElementById("restart-required-notice");e&&e.classList.remove("hidden")}function R(){L("settings-log-level","/settings","logLevel",f),m("settings-host","/settings","host",500,{onSuccess:f}),m("settings-port","/settings","port",500,{onSuccess:f}),m("settings-proxy-port","/settings","proxyPort",500,{onSuccess:f})}function B(){R()}C();window.toggleTheme=v;window.stopServer=P;window.restartServer=N;window.blockClicks=u;window.unblockClicks=a;document.addEventListener("DOMContentLoaded",()=>{I(),B()});})();
